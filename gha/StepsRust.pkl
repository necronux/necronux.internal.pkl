// ==-----------------------------------------------------------== //
// SPDX-FileCopyrightText: Â© 2025 Nayan Patil <nayantsg@proton.me>
//
// SPDX-License-Identifier: Apache-2.0
// ==-----------------------------------------------------------== //

@ModuleInfo { minPklVersion = "0.27.0" }
module StepsRust

import "../schemas/GitHubAction.pkl" as gha

import "ActionsRegistry.pkl" as ActReg
import "UtilsCommon.pkl"

const function setupRustToolchain(toolchain: String) = new gha.Step {
  ...UtilsCommon.setupRustToolchainCommon("cargo")
  with {
    ["toolchain"] = toolchain
  }
}

const function setupRustToolchainWithComponent(toolchain: String, component: String) = (setupRustToolchain(toolchain)) {
  with {
    ["components"] = component
  }
}
const function setupRustToolchainWithTarget(toolchain: String, target: String) = (setupRustToolchain(toolchain)) {
  with {
    ["targets"] = target
  }
}
const function setupRustToolchainFull(toolchain: String, component: String, target: String) = (setupRustToolchain(toolchain, component)) {
  with {
    ["targets"] = target
  }
}

const function setupRustCache(key: String, ref: String) = new gha.Step {
  name = "Setup rust cache"
  uses = ActReg.rustCache
  with {
    ["prefix-key"] = "rs"
    ["save-if"] = "${{ github.ref == '\(ref)' }}"
    ["key"] = "[\(key)]"
  }
}

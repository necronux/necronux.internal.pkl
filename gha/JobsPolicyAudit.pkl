// ==-----------------------------------------------------------== //
// SPDX-FileCopyrightText: Â© 2025 Nayan Patil <nayantsg@proton.me>
//
// SPDX-License-Identifier: Apache-2.0
// ==-----------------------------------------------------------== //

@ModuleInfo { minPklVersion = "0.27.0" }
module JobsPolicyAudit

import "../schemas/GitHubAction.pkl" as gha

import "ActionsRegistry.pkl" as ActReg
import "StepsCommon.pkl"
import "UtilsCommon.pkl"

const function reuseCompliance() = new gha.Job {
  name = "REUSE Compliance Check"
  steps {
    StepsCommon.checkout(null)
    new {
      name = "REUSE Compliance Check"
      uses = ActReg.reuseAction
    }
  }
} |> UtilsCommon.standardJobConfig(null, null)

const function cargoDeny() = new gha.Job {
  name = "Cargo Deny"
  steps {
    StepsCommon.checkout(null)
    new {
      name = "Run cargo deny check without advisories"
      uses = ActReg.cargoDenyAction
      with {
        ["command"] = "check bans licenses sources"
        ["rust-version"] = "stable"
      }
    }
    new {
      name = "Run cargo deny check advisories"
      // Prevent sudden announcement of a new advisory from failing ci:
      run = "cargo cargo-deny check advisories || { echo 'Advisories check failed, but continuing the workflow...'; exit 0; }"
      shell = "bash"
    }
  }
} |> UtilsCommon.standardJobConfig(null, null)

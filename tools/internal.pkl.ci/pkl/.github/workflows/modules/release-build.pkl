// ==-----------------------------------------------------------== //
// SPDX-FileCopyrightText: Â© 2025 Nayan Patil <nayantsg@proton.me>
//
// SPDX-License-Identifier: Apache-2.0
// ==-----------------------------------------------------------== //

@ModuleInfo { minPklVersion = "0.27.0" }
module ReleaseBuild

import ".../schemas/GitHubAction.pkl" as gha

import ".../gha/ActionsRegistry.pkl" as ActReg
import ".../gha/StepsCommon.pkl"
import ".../gha/UtilsCommon.pkl"

const function necronuxInternalPkl() = new gha.Job {
  name = "Build necronux.internal.pkl"
  steps {
    StepsCommon.checkoutWithRef(0, "${{ github.ref }}")
    StepsCommon.installAction("just")
    new {
      name = "Build release package"
      run = "just make-internalpkg"
      shell = "bash"
    }
    new {
      name =  "Determine package dir path and archive name"
      run = """
      pkgdir="build/generated/pkl/packages"
      echo "PKGDIR=$pkgdir" >> $GITHUB_ENV
      echo "ARCHIVE=${{ github.ref_name }}" >> $GITHUB_ENV
      """
      shell = "bash"
    }
    new {
      name = "Create directory for archive and transfer files"
      run = """
      mkdir -p "$ARCHIVE"
      cp "$PKGDIR"/${{ github.ref_name }} "$ARCHIVE"/
      cp "$PKGDIR"/${{ github.ref_name }}.sha256 "$ARCHIVE"/
      cp "$PKGDIR"/${{ github.ref_name }}.zip "$ARCHIVE"/
      cp "$PKGDIR"/${{ github.ref_name }}.zip.sha256 "$ARCHIVE"/
      """
      shell = "bash"
    }
    new {
      name = "Build archive"
      run = """
      tar czf "$ARCHIVE.tar.gz" "$ARCHIVE"
      shasum -a 256 "$ARCHIVE.tar.gz" > "$ARCHIVE.tar.gz.sha256"
      echo "ASSET=$ARCHIVE.tar.gz" >> $GITHUB_ENV
      echo "ASSET_SUM=$ARCHIVE.tar.gz.sha256" >> $GITHUB_ENV
      """
      shell = "bash"
    }
    new {
      name = "Upload pkgs, zips and sums"
      uses = ActReg.uploadArtifact
      with {
        ["name"] = "${{ github.ref_name }}"
        ["overwrite"] = true
        ["compression-level"] = 9
        ["path"] = """
        ${{ env.ASSET }}
        ${{ env.ASSET_SUM }}
        """
      }
    }
  }
} |> UtilsCommon.standardJobConfig(null, null)
